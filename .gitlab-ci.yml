image: registry.gitlab.com/berniwittmann/beachanmeldung:latest

services:
    - postgres:latest

stages:
  - lint
  - test
  - deploy

variables:
    SECRET_KEY: test-secret
    POSTGRES_DB: beachtest
    POSTGRES_USER: beachtest
    POSTGRES_PASSWORD: beachtest
    LANGUAGE_CODE: en-us
    TIME_ZONE: Europe/Berlin
    DEFAULT_EMAIL_FROM: test@beach.handballismaning.de
    SERVER_EMAIL: test@beach.handballismaning.de.de


backend_tests:
    stage: test
    before_script:
    - export DATABASE_NAME=beachtest
    - export DATABASE_USER=beachtest
    - export DATABASE_PASSWORD=beachtest
    - export DATABASE_HOST=postgres
    - source /app/venv/bin/activate
    script:
        - coverage run manage.py test
    after_script:
    - source /app/venv/bin/activate
    - coverage report
    - coverage html
    artifacts:
      paths:
      - htmlcov
      expire_in: 4 weeks
    exclude:
    - master

backend_lint:
  stage: lint
  before_script:
  - source /app/venv/bin/activate
  script:
        - flake8
  exclude:
  - master

frontend_tests:
    stage: test
    before_script:
        - cd web/vueapp
        - cp -R /app/node_modules .
    script:
        - npm run test
    artifacts:
      paths:
      - web/vueapp/test/unit/reports
      - web/vueapp/test/unit/coverage
      expire_in: 4 weeks
    exclude:
    - master

frontend_lint:
    stage: lint
    before_script:
        - cd web/vueapp
        - cp -R /app/node_modules .
    script:
        - npm run lint
    exclude:
    - master

deploy:
    stage: deploy
    script:
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - gem install dpl
    - cd web/vueapp
    - npm run build
    - cd ../..
    - dpl --provider=heroku --app=beachanmeldung --api-key=$HEROKU_PRODUCTION_API_KEY
    only:
     â€” master